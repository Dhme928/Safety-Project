<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1pT2_mI_B9CrnOde6YK__OzBd2gYEppXy">
  <link rel="icon" type="image/png" href="https://drive.google.com/uc?export=view&id=1pT2_mI_B9CrnOde6YK__OzBd2gYEppXy">
  <title>Safety Observations üë∑</title>
  <style>
    body { font-family: 'Arial', sans-serif; margin:0; padding:0; background-color:#e9e9e9; height:100vh; overflow:hidden; }
    .app-container { display:flex; flex-direction:column; height:90%; max-width:500px; margin:0 auto; background-color:white; box-shadow:0 0 15px rgba(0,0,0,0.2); }
    .header { text-align:center; padding:15px; font-size:18px; font-weight:bold; background-color:#333; color:white; border-bottom:1px solid #FF8C00; }
    .content-area { flex-grow:1; overflow-y:auto; margin-bottom:60px; }
    .tab-content { padding:10px 12px; display:none; height:100%; }
    .tab-content.active { display:block; }
    iframe { width:100%; height:calc(100vh - 130px); border:none; }
    #InfoTab { overflow-y:auto; max-height:calc(100vh - 130px); padding-bottom:100px; }
    .announcement-card { background-color:white; border-radius:8px; margin-bottom:12px; padding:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-left:5px solid #FF8C00; cursor:pointer; }
    .card-title { font-weight:bold; color:#333; font-size:16px; margin-bottom:5px; text-align:center; }
    .card-date { font-size:10px; color:#888; margin-bottom:10px; border-bottom:1px dashed #eee; padding-bottom:5px; }
    .card-content { font-size:13px; color:#555; display:block; text-align:center; } 
    .info-month { font-size:18px; font-weight:bold; margin:8px 0 14px 0; text-align:center; }
    .accordion { background-color:#f0f0f0; color:#222; cursor:pointer; padding:12px; width:100%; text-align:left; border:none; outline:none; transition:0.25s; font-size:15px; border-radius:6px; font-weight:700; }
    .accordion:hover, .accordion.activeAcc { background-color:#e0e0e0; }
    .panel { padding:12px 14px; display:none; background-color:white; overflow-y:auto; border-left:4px solid #FF8C00; margin-top:8px; border-radius:6px; max-height:500px; }
    .panel ol, .panel ul { padding-left:20px; margin:0; line-height:1.6; font-size:14px; color:#333; }
    .panel li { margin-bottom:6px; }
    .nav-bar { display:flex; justify-content:space-around; position:fixed; bottom:0; width:100%; max-width:500px; height:60px; background-color:white; box-shadow:0 -5px 15px rgba(0,0,0,0.15); z-index:10; left:50%; transform:translateX(-50%); }
    .nav-button { display:flex; flex-direction:column; align-items:center; justify-content:center; color:#777; font-size:11px; cursor:pointer; width:20%; transition:color 0.3s; }
    .nav-button.active { color:#FF8C00; font-weight:bold; }
    .nav-button:hover { color:#FF8C00; }
    .nav-icon { font-size:20px; margin-bottom:3px; }
    .icon-news::before { content:"üì∞"; }
    .icon-form::before { content:"üìù"; }
    .icon-data::before { content:"üìä"; }
    .icon-tasks::before { content:"‚úÖ"; }
    .icon-info::before { content:"‚ÑπÔ∏è"; }
    @media (min-width:600px) {
      .app-container { max-width:1000px; height:90vh; margin-top:5vh; margin-bottom:5vh; border-radius:12px; overflow:hidden; }
      .nav-bar { max-width:1000px; }
      .content-area { margin-bottom:60px; }
      .nav-button span { font-size:14px; }
      .nav-icon { font-size:24px; }
      .announcement-card { max-width:800px; margin-left:auto; margin-right:auto; }
    }
    
    /* MODAL STYLES */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 20; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.7); 
        padding-top: 60px;
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto; /* 5% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 90%; 
        max-width: 400px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close-btn:hover,
    .close-btn:focus {
        color: #333;
        text-decoration: none;
    }
    #leaderboardTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    #leaderboardTable th, #leaderboardTable td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        font-size: 14px;
    }
    #leaderboardTable th {
        background-color: #f2f2f2;
        color: #333;
        text-align: center;
    }
    #leaderboardTable tr:nth-child(1) td {
        background-color: gold; 
        font-weight: bold;
    }
    #leaderboardTable tr:nth-child(2) td {
        background-color: silver;
    }
    #leaderboardTable tr:nth-child(3) td {
        background-color: #cd7f32; /* Bronze */
        color: white;
    }
  </style>
</head>
<body>

<div id="leaderboardModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 style="text-align:center; color:#333; margin-top:0;">üèÜ Monthly Leaderboard</h2>
    <div id="leaderboardContainer">Loading leaderboard...</div>
  </div>
</div>
<div class="app-container">
  <div class="header">Safety Observations üë∑ ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™Ÿä</div>

  <div class="content-area">

    <div id="NewsTab" class="tab-content">
      <div id="AnnouncementsContainer">
        <div class="announcement-card">
          <div class="card-date">Loading...</div>
          <div class="card-title">Fetching news...</div>
          <div class="card-content" style="display:block;">Loading content...</div>
        </div>
      </div>
    </div>

    <div id="FormTab" class="tab-content">
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfYED_4UfHcmWn0fQOjtR5s8A0-Bhr4dwpe-80GjKkLeTR_Lw/viewform?embedded=true"></iframe>
    </div>

    <div id="DataTab" class="tab-content">
      <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTXlN-sE-IkQJLMaVOvRGSBYNLsDvwZTD15w7rarTIXBGoacF0C5_eiI7OmFs__zA8jtlwhy0ULLZ8N/pubhtml"></iframe>
    </div>

    <div id="TasksTab" class="tab-content">
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSezm0wWTdEsvkIdnzhfpRf0G37tZzqbY-AF-BHfbXXiLr2rKA/viewform?embedded=true"></iframe>
    </div>

    <div id="InfoTab" class="tab-content">
      <div class="info-month"> The Color Code of This Month is: <span id="colorName">...</span></div>

      <div class="announcement-card" id="eomCard" style="border:2px solid gold; margin-bottom:12px; cursor:pointer;">
        <div class="card-title" id="eomCardTitle" style="color:black; font-size:18px;">ü¶∫ The Employee of the Month :</div>
        <div class="card-content" id="employeeOfMonth" style="font-size:18px; font-weight:bold; color:black;">Loading...</div>
      </div>

      <button class="accordion" id="safetyAccordion">ü¶∫ Safety Responsibilities</button>
      <div class="panel" id="safetyPanel">
        <ol>
          <li>Reporting chain to follow site HSE / Safety Supervisor, Coordinator & Manager.</li>
          <li>Visibly demonstrate the priority of safety in all activities, including setting a good personal example.</li>
          <li>Understand and be familiar with safety and health requirements of the contract, as well as CSSP, HIP, JSA, GI‚Äôs, CSM, local laws, and other best practices.</li>
          <li>Conduct all TBTs (Daily, Weekly & Mass) with site workers and construction supervisory staff, and hand over accurate records to the HSE Supervisor at the end of each shift.</li>
          <li>Conduct frequent HSE inspections of the assigned location and continuously monitor ongoing activities.</li>
          <li>Report all NM, FAI, CA & PA to your immediate HSE Supervisor.</li>
          <li>Report all incidents that result in injury or property damage to your immediate HSE Supervisor.</li>
          <li>Report misuse of equipment, tools, or facilities to your immediate HSE Supervisor.</li>
          <li>Report any severe arguments, signs of prejudice, bullying, or fighting to your immediate HSE Supervisor.</li>
          <li>Report any other Health, Safety, or Environmental concerns to your immediate HSE Supervisor.</li>
          <li>Report all unsafe situations and occurrences immediately.</li>
          <li>Be vigilant and present at the site location at all times while activities are ongoing to ensure safe operations.</li>
          <li>Responsible and accountable for accurate and timely reporting of all HSE issues to the assigned HSE Supervisor.</li>
          <li>Whenever the Safety Officer has an HSE concern, report it immediately to the person in charge (Foreman, Supervisor, or Site Engineer), regardless of the action taken, and submit a report to the HSE Supervisor or HSE Coordinator/Manager.</li>
          <li>Report any mistreated behavior immediately and submit a written report to the HSE Supervisor or HSE Coordinator/Manager.</li>
          <li>Fill out observation forms clearly and concisely for all unsafe occurrences, obtain signatures from the activity foreman/supervisor/site engineer, and hand them over to the HSE Supervisor.</li>
          <li>Maintain accurate records of all activities related to HSE.</li>
          <li>Liaise with client representatives when instructed by the HSE Supervisor, Coordinator, or Manager.</li>
          <li>Monitor and close all site-related PSI points, HSE findings, and observations raised during audits, inspections, or site visits by client or management.</li>
          <li>Follow up with construction site supervision to close all site HSE issues and concerns.</li>
          <li>Provide correctly and accurately filled checklists, including but not limited to heavy equipment, daily site inspection, and portable electrical tools checklists.</li>
          <li>Inspect and monitor subcontractor activities to ensure compliance with the OHS management system.</li>
          <li>Ensure that subcontractors and visitors receive safety orientation prior to entering the site.</li>
          <li>Ensure all equipment is in safe working condition and report abnormalities immediately.</li>
          <li>Ensure no N.D.E. is carried out if it may endanger any person.</li>
          <li>Ensure 100% compliance with the work permit system at the site (Client and CAT).</li>
          <li>Ensure that equipment operators are competent and hold valid certificates.</li>
          <li>Carry out monthly inspections, including fire extinguishers, rigging, and lifting equipment.</li>
          <li>Ensure all tools and electrical equipment are in good condition and safe to use.</li>
          <li>Ensure scaffolding platforms and ladders are safe, secured, inspected, and tagged before use.</li>
          <li>Ensure the jobsite is kept tidy and waste materials are removed at the end of each shift.</li>
          <li>Stop work as per HSI 063 and the Area Manager Stop Work Authority Policy.</li>
          <li>Participate in or conduct incident investigations, safety meetings, drills, and safety training sessions.</li>
          <li>Assist in implementing the waste management plan at the project site and camp.</li>
          <li>Follow and implement all written and verbal business-related instructions given by your seniors.</li>
        </ol>
      </div>

      <button class="accordion">üí° Daily Safety Tip</button>
      <div class="panel">
        <ul>
          <li>Stay hydrated during long shifts ‚òÄÔ∏è</li>
          <li>Always wear your PPE üë∑‚Äç‚ôÇÔ∏è</li>
          <li>Report near misses promptly üßæ</li>
          <li>Use proper lifting techniques üí™</li>
        </ul>
      </div>

      <button class="accordion">üîó Useful Links</button>
      <div class="panel">
        <ul>
          <li><a href="https://drive.google.com/file/d/15gvUFs5ELvaUhDVTapkvGf6a5GkGEx5s/view?usp=sharing" target="_blank">üìò CSM Book</a></li>
          <li><a href="https://drive.google.com/file/d/109vG3Hk3PdgvQF87k0EJ1IiKDTDfdQTv/view?usp=sharing" target="_blank">üìó Saudi Aramco Safety HandBook</a></li>
        </ul>
      </div>
    </div>

  </div>

  <div class="nav-bar">
    <div class="nav-button" onclick="openTab(event, 'NewsTab')"><span class="nav-icon icon-news"></span><span>News</span></div>
    <div class="nav-button" onclick="openTab(event, 'FormTab')"><span class="nav-icon icon-form"></span><span>Observation</span></div>
    <div class="nav-button" onclick="openTab(event, 'DataTab')"><span class="nav-icon icon-data"></span><span>Safety Data</span></div>
    <div class="nav-button" onclick="openTab(event, 'TasksTab')"><span class="nav-icon icon-tasks"></span><span>Daily Tasks</span></div>
    <div class="nav-button" onclick="openTab(event, 'InfoTab')"><span class="nav-icon icon-info"></span><span>Info</span></div>
  </div>
</div>

<script>
// Global variables for modal and sheet data
const eomSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0Km9p6XYDDxyGYSFfUjDjhdKMtr_hFvCiJ-U5_24_-QKrGsexZ4v3dxzKp0K1XZenNsiV7CiNmQEt/pub?output=csv';
let leaderboardData = []; // Store the fetched data here

function openTab(evt, tabName) {
  var tabcontent = document.getElementsByClassName("tab-content");
  var navbuttons = document.getElementsByClassName("nav-button");
  for (var i = 0; i < tabcontent.length; i++) tabcontent[i].classList.remove('active');
  for (var i = 0; i < navbuttons.length; i++) navbuttons[i].classList.remove("active");
  var currentTab = document.getElementById(tabName);
  currentTab.classList.add('active');
  
  var targetButton = evt.currentTarget.classList.contains('nav-button') 
                     ? evt.currentTarget 
                     : document.querySelector(`.nav-button[onclick*="'${tabName}'"]`);
  if (targetButton) targetButton.classList.add("active");
}

function showLeaderboardModal() {
    const modal = document.getElementById('leaderboardModal');
    const container = document.getElementById('leaderboardContainer');
    
    // Check if data is loaded
    if (leaderboardData.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>Loading data... Please try again in a moment.</p>";
    } else {
        // Sort data by Points (descending)
        const sortedData = [...leaderboardData].sort((a, b) => b.points - a.points);
        
        // Build the HTML table
        let tableHTML = '<table id="leaderboardTable"><thead><tr><th>Rank</th><th>Safety Officer Name</th><th>Points</th></tr></thead><tbody>';
        
        sortedData.forEach((item, index) => {
            tableHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.points}</td>
                </tr>
            `;
        });
        
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    modal.style.display = 'block';
}

function hideLeaderboardModal() {
    document.getElementById('leaderboardModal').style.display = 'none';
}


document.addEventListener('click', function(e) {
  if (e.target.classList.contains('accordion')) {
    e.target.classList.toggle('activeAcc');
    var panel = e.target.nextElementSibling;
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
  }
});

(function setMonthColor() {
  const cycle = ['Red','Blue','Yellow','Green'];
  const startIndexMonth = 9; 
  const m = new Date().getMonth();
  const offset = ((m - startIndexMonth) % 4 + 4) % 4;
  const color = cycle[offset];
  const colorNameEl = document.getElementById('colorName');
  if (colorNameEl) {
    colorNameEl.textContent = color;
    colorNameEl.style.color = color.toLowerCase();
  }
})();

document.addEventListener('DOMContentLoaded', () => {
  // Set default tab to Info
  const infoButton = document.querySelector('.nav-button[onclick*="InfoTab"]');
  if(infoButton) openTab({currentTarget: infoButton}, 'InfoTab');

  // --- MODAL SETUP ---
  const eomCard = document.getElementById('eomCard');
  const modal = document.getElementById('leaderboardModal');
  const closeBtn = document.querySelector('.close-btn');

  if (eomCard) eomCard.addEventListener('click', showLeaderboardModal);
  if (closeBtn) closeBtn.addEventListener('click', hideLeaderboardModal);
  window.addEventListener('click', (event) => {
      if (event.target == modal) hideLeaderboardModal();
  });
  // -------------------

  // Set the current Month and Year
  const now = new Date();
  const options = { month: 'long', year: 'numeric' };
  const currentMonthYear = now.toLocaleDateString('en-US', options); 
  const cardTitleElement = document.getElementById('eomCardTitle');
  if (cardTitleElement) {
    cardTitleElement.textContent = `üèÜ Employee of the Month (${currentMonthYear})`;
  }

  // --- Employee of the Month/Leaderboard Data Fetch ---
  fetch(eomSheetUrl)
    .then(res => res.text())
    .then(csvText => {
      const rows = csvText.split('\n').slice(1);
      let maxPoints = -1;
      let topEmployee = '';
      
      rows.forEach(row => {
        if(row.trim() === '') return;
        const cols = row.split(',').map(col => col.replace(/["']/g,'').trim());
        
        const name = cols[0];
        const points = parseFloat(cols[1]);

        if(!isNaN(points) && name.trim() !== '') {
            // Populate data for the modal
            leaderboardData.push({ name: name, points: points });

            // Find the overall top employee for the main card
            if(points > maxPoints){
              maxPoints = points;
              topEmployee = name.trim();
            }
        }
      });
      
      const el = document.getElementById('employeeOfMonth');
      if(el) el.textContent = topEmployee || 'No data (Check sheet data)';
      
    })
    .catch(err => {
      const el = document.getElementById('employeeOfMonth');
      if(el) el.textContent = 'Error loading data (Link Check)';
      console.error('Error fetching Employee of the Month:', err);
    });

  // --- Load News from Google Sheet ---
  const newsSheetUrl = 'https://docs.google.com/spreadsheets/d/1_SwxL5f4mWF5kd2yofCMCEE_WQp_2eroHDhXXPXtw1U/export?format=csv&gid=0';
  fetch(newsSheetUrl)
    .then(res => res.text())
    .then(csvText => {
      const rows = csvText.split('\n').slice(1);
      const container = document.getElementById('AnnouncementsContainer');
      container.innerHTML = '';
      rows.forEach(row => {
        if(row.trim() === '') return;
        
        const [date, title, content] = row.split(','); 
        const card = document.createElement('div');
        card.className = 'announcement-card';
        card.innerHTML = `
          <div class="card-date">${date ? date.trim() : ''}</div>
          <div class="card-title">${title ? title.trim() : ''}</div>
          <div class="card-content" style="display:none;">${content ? content.trim() : ''}</div>
        `;
        container.appendChild(card);
        
        card.querySelector('.card-title').addEventListener('click', () => {
          const contentDiv = card.querySelector('.card-content');
          contentDiv.style.display = (contentDiv.style.display === 'none') ? 'block' : 'none';
        });
      });
    })
    .catch(err => {
      const container = document.getElementById('AnnouncementsContainer');
      container.innerHTML = `<div class="announcement-card">
                              <div class="card-date">Error</div>
                              <div class="card-title">Failed to fetch news</div>
                            </div>`;
      console.error('Error loading news:', err);
    });
});
</script>
</body>
</html>
